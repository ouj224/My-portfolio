<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>BOARD</title>
  <link href="style.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header>
    <div class="header-container">
      <div class="logo"><a href="index.html">MY PORTFOLIO</a></div>
      <nav>
        <ul>
          <li><a href="about.html">ABOUT</a></li>
          <li><a href="resume.html">RESUME</a></li>
          <li><a href="project.html">PROJECT</a></li>
          <li><a href="library.html">LIBRARY</a></li>
          <li><a href="contact.html">CONTACT</a></li>
          <li><a href="board.html" class="active">BOARD</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="sub-banner"><h2>COMMUNITY BOARD</h2></div>

  <div class="container">
    <div class="content-header">
      <h3>자유 게시판</h3>
      <button onclick="openWriteModal()" class="btn-upload"><i class="fas fa-pen"></i> 글쓰기</button>
    </div>

    <table class="board-table">
        <thead>
            <tr>
                <th width="8%">No.</th>
                <th width="50%">제목</th>
                <th width="15%">작성자</th>
                <th width="12%">작성일</th>
                <th width="15%">반응</th>
            </tr>
        </thead>
        <tbody id="boardList"></tbody>
    </table>
  </div>

  <div id="writeModal" class="modal-overlay">
      <div class="modal-content">
          <span class="close-modal" onclick="closeWriteModal()">&times;</span>
          <h3>새 게시글 작성</h3>
          <input type="text" id="postTitle" placeholder="제목" class="auth-input">
          <textarea id="postContent" rows="8" placeholder="내용을 입력하세요" class="resume-editor" style="min-height:200px; margin-top:10px;"></textarea>
          <button onclick="submitPost()" class="btn-upload" style="width:100%; margin-top:10px;">등록하기</button>
      </div>
  </div>

  <div id="detailModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px;">
        <span class="close-modal" onclick="closeDetailModal()">&times;</span>
        
        <h2 id="detailTitle" style="color:#004098; margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:10px;"></h2>
        <div style="margin-bottom:20px; color:#888; font-size:0.9rem; display:flex; justify-content:space-between;">
            <span>작성자: <b id="detailAuthor"></b></span>
            <span id="detailDate"></span>
        </div>
        
        <div id="detailContent" class="post-detail-content"></div>

        <div style="text-align:center; margin: 20px 0;">
            <button id="btnLike" class="like-btn" style="font-size:1rem; padding:8px 20px; margin-right:10px;">
                <i class="fas fa-thumbs-up"></i> <span id="likeCount">0</span>
            </button>
            <button id="btnDislike" class="dislike-btn" style="font-size:1rem; padding:8px 20px;">
                <i class="fas fa-thumbs-down"></i> <span id="dislikeCount">0</span>
            </button>
        </div>

        <div id="ownerActions" style="text-align:right; display:none; margin-bottom:20px;">
            <button onclick="deleteCurrentPost()" class="btn-upload" style="background-color:#e74c3c; padding:5px 10px; font-size:0.9rem;">삭제하기</button>
        </div>

        <div class="comment-section">
            <h4>댓글 <span id="commentCount">0</span></h4>
            <div id="commentList" class="comment-list"></div>
            
            <div class="comment-form">
                <input type="text" id="commentInput" class="comment-input" placeholder="댓글을 입력하세요...">
                <button onclick="submitComment()" class="btn-upload" style="padding: 8px 15px;">등록</button>
            </div>
        </div>
    </div>
  </div>

  <footer>
    <div class="footer-content"><p>Copyright © 2025 All Rights Reserved.</p></div>
  </footer>

  <script src="script.js"></script>
  <script>
    let currentUserId = null; 
    let currentPostId = null;
    let allPosts = []; // 게시글 데이터 저장용

    document.addEventListener("DOMContentLoaded", () => {
        fetch('/api/me').then(res => res.json()).then(data => {
            currentUserId = data.userId;
            loadPosts();
        });
    });

    function loadPosts() {
        fetch('/api/posts').then(res => res.json()).then(posts => {
            allPosts = posts; // 데이터 저장
            const tbody = document.getElementById('boardList');
            if(posts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding:30px;">게시글이 없습니다.</td></tr>';
                return;
            }
            tbody.innerHTML = posts.map((post, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td style="text-align:left; padding-left:20px;">
                        <span class="board-title-link" onclick="openDetailModal('${post._id}')">
                            ${post.title} 
                            <span style="font-size:0.8rem; color:#888;">[${post.comments ? post.comments.length : 0}]</span>
                        </span>
                    </td>
                    <td>${post.authorName}</td>
                    <td>${new Date(post.createdAt).toLocaleDateString()}</td>
                    <td>
                        <div class="vote-container">
                            <span style="color:#3498db"><i class="fas fa-thumbs-up"></i> ${post.likes ? post.likes.length : 0}</span>
                            <span style="color:#e74c3c"><i class="fas fa-thumbs-down"></i> ${post.dislikes ? post.dislikes.length : 0}</span>
                        </div>
                    </td>
                </tr>
            `).join('');
        });
    }

    // 상세 모달 열기 (ID로 데이터 찾기)
    function openDetailModal(postId) {
        const post = allPosts.find(p => p._id === postId);
        if(!post) return;

        currentPostId = post._id;
        
        // 내용 채우기
        document.getElementById('detailTitle').innerText = post.title;
        document.getElementById('detailAuthor').innerText = post.authorName;
        document.getElementById('detailDate').innerText = new Date(post.createdAt).toLocaleString();
        
        // ★ 본문 내용 채우기 (여기가 중요합니다!)
        document.getElementById('detailContent').innerText = post.content || "내용이 없습니다.";

        // 추천/비추천 수 채우기
        document.getElementById('likeCount').innerText = post.likes ? post.likes.length : 0;
        document.getElementById('dislikeCount').innerText = post.dislikes ? post.dislikes.length : 0;

        // 버튼 클릭 이벤트 연결
        document.getElementById('btnLike').onclick = () => votePost('like');
        document.getElementById('btnDislike').onclick = () => votePost('dislike');
        
        // 삭제 버튼 표시 여부
        if(currentUserId && parseInt(post.userId) === parseInt(currentUserId)) {
            document.getElementById('ownerActions').style.display = 'block';
        } else {
            document.getElementById('ownerActions').style.display = 'none';
        }

        renderComments(post.comments || []);
        document.getElementById('detailModal').classList.add('open');
    }

    // 추천/비추천 요청
    function votePost(type) {
        fetch(`/api/posts/${currentPostId}/${type}`, { method: 'POST' })
            .then(() => {
                // 목록 다시 불러오고 모달 내용 갱신을 위해 닫았다가 다시 열거나, 데이터를 다시 fetch 해야 함
                // 여기서는 간단히 로드 후 모달 닫기 방지 로직 (새로고침)
                loadPostsAfterVote();
            });
    }

    // 투표 후 모달 내용만 갱신하는 함수
    function loadPostsAfterVote() {
        fetch('/api/posts').then(res => res.json()).then(posts => {
            allPosts = posts;
            const updatedPost = posts.find(p => p._id === currentPostId);
            if(updatedPost) {
                // 카운트만 업데이트
                document.getElementById('likeCount').innerText = updatedPost.likes ? updatedPost.likes.length : 0;
                document.getElementById('dislikeCount').innerText = updatedPost.dislikes ? updatedPost.dislikes.length : 0;
            }
            loadPosts(); // 뒤에 목록도 갱신
        });
    }

    function renderComments(comments) {
        document.getElementById('commentCount').innerText = comments.length;
        const list = document.getElementById('commentList');
        list.innerHTML = comments.map(c => `
            <div class="comment-item">
                <span class="comment-author">${c.authorName}</span>
                <span class="comment-date">${new Date(c.createdAt).toLocaleString()}</span>
                <div style="margin-top:5px;">${c.content}</div>
            </div>
        `).join('');
    }

    function submitComment() {
        const content = document.getElementById('commentInput').value;
        if(!content) return;
        fetch(`/api/posts/${currentPostId}/comments`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ content })
        }).then(() => {
            document.getElementById('commentInput').value = '';
            alert('댓글 등록 완료!');
            
            // 데이터 갱신
            fetch('/api/posts').then(res => res.json()).then(posts => {
                allPosts = posts;
                const updatedPost = posts.find(p => p._id === currentPostId);
                renderComments(updatedPost.comments || []);
                loadPosts();
            });
        });
    }

    function deleteCurrentPost() {
        if(confirm('정말 삭제하시겠습니까?')) {
            fetch(`/api/posts/${currentPostId}`, { method: 'DELETE' })
                .then(res => {
                    if(res.ok) {
                        alert('삭제되었습니다.');
                        closeDetailModal();
                        loadPosts();
                    } else { alert('실패'); }
                });
        }
    }

    function submitPost() {
        const title = document.getElementById('postTitle').value;
        const content = document.getElementById('postContent').value;
        if(!title || !content) { alert('내용 입력!'); return; }
        fetch('/api/posts', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ title, content })
        }).then(() => {
            closeWriteModal();
            loadPosts();
        });
    }

    function openWriteModal() { document.getElementById('writeModal').classList.add('open'); }
    function closeWriteModal() { document.getElementById('writeModal').classList.remove('open'); }
    function closeDetailModal() { document.getElementById('detailModal').classList.remove('open'); }
  </script>
</body>
</html>