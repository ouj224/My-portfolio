<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>BOARD</title>
  <link href="style.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header>
    <div class="header-container">
      <div class="logo"><a href="index.html">MY PORTFOLIO</a></div>
      <nav>
        <ul>
          <li><a href="about.html"><img src="images/icon_about.png" alt="about" class="menu-icon"> ABOUT</a></li>
          <li><a href="resume.html"><img src="images/icon_resume.png" alt="resume" class="menu-icon"> RESUME</a></li>
          <li><a href="project.html"><img src="images/icon_project.png" alt="project" class="menu-icon"> PROJECT</a></li>
          <li><a href="library.html"><img src="images/icon_library.png" alt="library" class="menu-icon"> LIBRARY</a></li>
          <li><a href="contact.html"><img src="images/icon_contact.png" alt="contact" class="menu-icon"> CONTACT</a></li>
          <li><a href="board.html" class="active"><img src="images/icon_board.png" alt="board" class="menu-icon"> BOARD</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="sub-banner"><h2>COMMUNITY BOARD</h2></div>

  <div class="container">
    <div class="content-header">
      <h3>ììœ  ê²Œì‹œíŒ</h3>
      <button onclick="openWriteModal()" class="btn-upload"><i class="fas fa-pen"></i> ê¸€ì“°ê¸°</button>
    </div>

    <table class="board-table">
        <thead>
            <tr>
                <th width="8%">No.</th>
                <th width="50%">ì œëª©</th>
                <th width="15%">ì‘ì„±ì</th>
                <th width="12%">ì‘ì„±ì¼</th>
                <th width="15%">ë°˜ì‘</th>
            </tr>
        </thead>
        <tbody id="boardList"></tbody>
    </table>
  </div>

  <div id="writeModal" class="modal-overlay">
      <div class="modal-content">
          <span class="close-modal" onclick="closeWriteModal()">&times;</span>
          <h3 id="modalTitle">ìƒˆ ê²Œì‹œê¸€ ì‘ì„±</h3>
          <input type="text" id="postTitle" placeholder="ì œëª©" class="auth-input">
          <textarea id="postContent" rows="8" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" class="resume-editor" style="min-height:200px; margin-top:10px;"></textarea>
          <div style="margin-top:10px;">
             <label style="font-weight:bold;">ì´ë¯¸ì§€ ì²¨ë¶€:</label>
             <input type="file" id="postFile" accept="image/*">
          </div>
          <button onclick="submitPost()" class="btn-upload" style="width:100%; margin-top:10px;">ì €ì¥í•˜ê¸°</button>
      </div>
  </div>

  <div id="detailModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px;">
        <span class="close-modal" onclick="closeDetailModal()">&times;</span>
        
        <h2 id="detailTitle" style="color:#004098; margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:10px;"></h2>
        <div style="margin-bottom:20px; color:#888; font-size:0.9rem; display:flex; justify-content:space-between;">
            <span>ì‘ì„±ì: <b id="detailAuthor"></b></span>
            <span id="detailDate"></span>
        </div>
        
        <div id="detailImageArea" class="detail-image-container" style="display:none;">
            <img id="detailImage" src="" alt="ì²¨ë¶€ ì´ë¯¸ì§€" class="detail-image">
        </div>

        <div id="detailContent" class="post-detail-content"></div>

        <div style="text-align:center; margin: 20px 0;">
            <button id="btnLike" class="like-btn" style="padding:8px 20px; margin-right:10px;"><i class="fas fa-thumbs-up"></i> <span id="likeCount">0</span></button>
            <button id="btnDislike" class="dislike-btn" style="padding:8px 20px;"><i class="fas fa-thumbs-down"></i> <span id="dislikeCount">0</span></button>
        </div>

        <div id="ownerActions" style="text-align:right; display:none; margin-bottom:20px;">
            <button onclick="openEditModal()" class="btn-upload" style="background-color:#f39c12; margin-right:5px;">ìˆ˜ì •</button>
            <button onclick="deleteCurrentPost()" class="btn-upload" style="background-color:#e74c3c;">ì‚­ì œ</button>
        </div>

        <div class="comment-section">
            <h4>ëŒ“ê¸€ <span id="commentCount">0</span></h4>
            <div id="commentList" class="comment-list"></div>
            <div class="comment-form">
                <input type="text" id="commentInput" class="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”...">
                <button onclick="submitComment()" class="btn-upload" style="padding: 8px 15px;">ë“±ë¡</button>
            </div>
        </div>
    </div>
  </div>

  <footer>
    <div class="footer-content"><p>Copyright Â© 2025 All Rights Reserved.</p></div>
  </footer>

  <script src="script.js"></script>
  <script>
    const API_ENDPOINT = '/api/posts';
    let currentUserId = null; 
    let currentPostId = null;
    let allPosts = [];
    let isEditing = false;

    document.addEventListener("DOMContentLoaded", () => {
        fetch('/api/me').then(res => res.json()).then(data => { currentUserId = data.userId; loadPosts(); });
    });

    function loadPosts() {
        fetch(API_ENDPOINT).then(res => res.json()).then(posts => {
            allPosts = posts;
            const tbody = document.getElementById('boardList');
            if(posts.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="padding:30px;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }
            tbody.innerHTML = posts.map((post, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td style="text-align:left; padding-left:20px;">
                        <span class="board-title-link" onclick="openDetailModal('${post._id}')">
                            ${post.title} ${post.fileName ? 'ğŸ–¼ï¸' : ''}
                            <span style="font-size:0.8rem; color:#888;">[${post.comments ? post.comments.length : 0}]</span>
                        </span>
                    </td>
                    <td>${post.authorName}</td>
                    <td>${new Date(post.createdAt).toLocaleDateString()}</td>
                    <td>
                        <span style="color:#3498db; margin-right:5px;"><i class="fas fa-thumbs-up"></i> ${post.likes ? post.likes.length : 0}</span>
                        <span style="color:#e74c3c"><i class="fas fa-thumbs-down"></i> ${post.dislikes ? post.dislikes.length : 0}</span>
                    </td>
                </tr>
            `).join('');
        });
    }

    function openDetailModal(postId) {
        const post = allPosts.find(p => p._id === postId);
        if(!post) return;
        currentPostId = post._id;
        
        document.getElementById('detailTitle').innerText = post.title;
        document.getElementById('detailAuthor').innerText = post.authorName;
        document.getElementById('detailDate').innerText = new Date(post.createdAt).toLocaleString();
        document.getElementById('detailContent').innerText = post.content || "";
        document.getElementById('likeCount').innerText = post.likes ? post.likes.length : 0;
        document.getElementById('dislikeCount').innerText = post.dislikes ? post.dislikes.length : 0;

        const imgArea = document.getElementById('detailImageArea');
        if (post.fileName) {
            document.getElementById('detailImage').src = `/uploads/${post.fileName}`;
            imgArea.style.display = 'block';
        } else {
            imgArea.style.display = 'none';
        }

        document.getElementById('btnLike').onclick = () => votePost('like');
        document.getElementById('btnDislike').onclick = () => votePost('dislike');
        
        document.getElementById('ownerActions').style.display = (currentUserId && parseInt(post.userId) === parseInt(currentUserId)) ? 'block' : 'none';
        renderComments(post.comments || []);
        document.getElementById('detailModal').classList.add('open');
    }

    // ëŒ“ê¸€ ë Œë”ë§ (ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í¬í•¨)
    function renderComments(comments) {
        document.getElementById('commentCount').innerText = comments.length;
        const list = document.getElementById('commentList');
        
        list.innerHTML = comments.map(c => {
            // ë³¸ì¸ ëŒ“ê¸€ì¸ì§€ í™•ì¸
            const isMyComment = currentUserId && parseInt(c.userId) === parseInt(currentUserId);
            
            return `
            <div class="comment-item" id="comment-${c._id}">
                <div class="comment-meta">
                    <span class="comment-author">${c.authorName}</span>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="comment-date">${new Date(c.createdAt).toLocaleString()}</span>
                        ${isMyComment ? `
                            <div class="comment-actions">
                                <button onclick="enableEditComment('${c._id}', '${c.content.replace(/'/g, "\\'")}')" class="btn-sm">ìˆ˜ì •</button>
                                <button onclick="deleteComment('${c._id}')" class="btn-sm delete">ì‚­ì œ</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="comment-content" id="content-${c._id}">${c.content}</div>
                <div class="edit-comment-area" id="edit-form-${c._id}" style="display:none;">
                    <input type="text" id="edit-input-${c._id}" class="edit-comment-input">
                    <button onclick="submitEditComment('${c._id}')" class="btn-sm">ì €ì¥</button>
                    <button onclick="cancelEditComment('${c._id}')" class="btn-sm">ì·¨ì†Œ</button>
                </div>
            </div>`;
        }).join('');
    }

    function submitComment() {
        const content = document.getElementById('commentInput').value;
        if(!content) return;
        fetch(`${API_ENDPOINT}/${currentPostId}/comments`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ content }) }).then(() => {
            document.getElementById('commentInput').value = '';
            refreshComments();
        });
    }

    // ëŒ“ê¸€ ì‚­ì œ
    function deleteComment(commentId) {
        if(!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        fetch(`${API_ENDPOINT}/${currentPostId}/comments/${commentId}`, { method: 'DELETE' })
            .then(() => refreshComments());
    }

    // ëŒ“ê¸€ ìˆ˜ì • ëª¨ë“œ í™œì„±í™”
    function enableEditComment(commentId, oldContent) {
        document.getElementById(`content-${commentId}`).style.display = 'none';
        document.getElementById(`edit-form-${commentId}`).style.display = 'flex';
        document.getElementById(`edit-input-${commentId}`).value = oldContent;
    }

    // ëŒ“ê¸€ ìˆ˜ì • ì·¨ì†Œ
    function cancelEditComment(commentId) {
        document.getElementById(`content-${commentId}`).style.display = 'block';
        document.getElementById(`edit-form-${commentId}`).style.display = 'none';
    }

    // ëŒ“ê¸€ ìˆ˜ì • ì œì¶œ
    function submitEditComment(commentId) {
        const newContent = document.getElementById(`edit-input-${commentId}`).value;
        if(!newContent) return;
        
        fetch(`${API_ENDPOINT}/${currentPostId}/comments/${commentId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ content: newContent })
        }).then(() => refreshComments());
    }

    // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ í—¬í¼
    function refreshComments() {
        fetch(API_ENDPOINT).then(res => res.json()).then(posts => {
            allPosts = posts;
            const updatedPost = posts.find(p => p._id === currentPostId);
            renderComments(updatedPost.comments || []);
            loadPosts(); // ëª©ë¡ ì¹´ìš´íŠ¸ ê°±ì‹ ìš©
        });
    }

    // (ê¸°ì¡´ ê²Œì‹œê¸€ ê¸°ëŠ¥ë“¤ - ìˆ˜ì •/ì‚­ì œ/ì¶”ì²œ ë“±)
    function openEditModal() {
        const post = allPosts.find(p => p._id === currentPostId);
        if (!post) return;
        isEditing = true;
        document.getElementById('modalTitle').innerText = "ê²Œì‹œê¸€ ìˆ˜ì •";
        document.getElementById('postTitle').value = post.title;
        document.getElementById('postContent').value = post.content;
        closeDetailModal();
        document.getElementById('writeModal').classList.add('open');
    }
    function openWriteModal() {
        isEditing = false;
        document.getElementById('modalTitle').innerText = "ìƒˆ ê²Œì‹œê¸€ ì‘ì„±";
        document.getElementById('postTitle').value = "";
        document.getElementById('postContent').value = "";
        document.getElementById('postFile').value = "";
        document.getElementById('writeModal').classList.add('open');
    }
    function submitPost() {
        const title = document.getElementById('postTitle').value;
        const content = document.getElementById('postContent').value;
        const fileInput = document.getElementById('postFile');
        if(!title) { alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        const formData = new FormData();
        formData.append('title', title);
        formData.append('content', content);
        if (fileInput.files[0]) formData.append('file', fileInput.files[0]);
        const url = isEditing ? `${API_ENDPOINT}/${currentPostId}` : API_ENDPOINT;
        const method = isEditing ? 'PUT' : 'POST';
        fetch(url, { method: method, body: formData }).then(() => { closeWriteModal(); loadPosts(); });
    }
    function deleteCurrentPost() { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) fetch(`${API_ENDPOINT}/${currentPostId}`, { method: 'DELETE' }).then(() => { closeDetailModal(); loadPosts(); }); }
    function votePost(type) { fetch(`${API_ENDPOINT}/${currentPostId}/${type}`, { method: 'POST' }).then(() => { fetch(API_ENDPOINT).then(res => res.json()).then(posts => { allPosts=posts; const updated=posts.find(p=>p._id===currentPostId); document.getElementById('likeCount').innerText=updated.likes.length; document.getElementById('dislikeCount').innerText=updated.dislikes.length; loadPosts(); }); }); }
    
    function closeWriteModal() { document.getElementById('writeModal').classList.remove('open'); }
    function closeDetailModal() { document.getElementById('detailModal').classList.remove('open'); }
  </script>
</body>
</html>